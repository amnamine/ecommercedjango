{% extends 'base.html' %}
{% block title %}Products · E‑Shop{% endblock %}
{% block content %}
<section class="hero">
  <h1 class="h1 slide-up">Discover Our Products</h1>
  <form method="get" class="filter">
    <input type="text" name="q" placeholder="Search products" value="{{ q }}" />
    <select name="category">
      <option value="">All Categories</option>
      {% for c in categories %}
      <option value="{{ c.slug }}" {% if active_category == c.slug %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
    <select name="sort">
      <option value="new" {% if sort == 'new' %}selected{% endif %}>Newest</option>
      <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price ↑</option>
      <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price ↓</option>
    </select>
    <button class="btn" type="submit">Apply</button>
  </form>
</section>

{% if featured %}
<section>
  <h2 class="h2">Featured</h2>
  <div class="grid">
    {% for p in featured %}
    <div class="card hover-rise">
      <a href="{% url 'shop:product_detail' p.id %}"><img class="img-el" src="{{ p.image_url }}" alt="{{ p.name }}" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22360%22><rect width=%22600%22 height=%22360%22 fill=%22%230b1222%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%238aa0b6%22 font-size=%2232%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>Image unavailable</text></svg>'" /></a>
      <div class="card-body">
        <h3 class="card-title">{{ p.name }}</h3>
        <p class="card-price">${{ p.price }}</p>
        <span class="badge">Featured</span>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<div class="grid">
  {% for p in products %}
  <div class="card hover-rise">
    <a href="{% url 'shop:product_detail' p.id %}">
      <img class="img-el" src="{{ p.image_url }}" alt="{{ p.name }}" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22360%22><rect width=%22600%22 height=%22360%22 fill=%22%230b1222%22/><text x=%2250%25%22 y=%2250%25%22 fill=%22%238aa0b6%22 font-size=%2232%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>Image unavailable</text></svg>'" />
    </a>
    <div class="card-body">
      <h3 class="card-title">{{ p.name }}</h3>
      <p class="card-price">${{ p.price }}</p>
      {% if p.category %}<span class="badge">{{ p.category.name }}</span>{% endif %}
      {% if p.avg_rating %}<span class="badge">★ {{ p.avg_rating|floatformat:1 }}</span>{% endif %}
      <div class="actions" style="margin-top:8px;display:flex;gap:8px">
        <a class="btn" href="{% url 'shop:add_to_cart' p.id %}">Add to cart</a>
        <a class="btn outline" href="{% url 'shop:product_detail' p.id %}">Details</a>
        <a class="btn outline" href="{% url 'shop:wishlist_add' p.id %}">Wishlist</a>
      </div>
    </div>
  </div>
  {% empty %}
    <p>No products yet.</p>
  {% endfor %}
</div>

<div class="pagination">
  {% if products.has_previous %}
    <a class="link" href="?q={{ q }}&category={{ active_category }}&sort={{ sort }}&page={{ products.previous_page_number }}">Prev</a>
  {% endif %}
  <span class="muted">Page {{ products.number }} of {{ products.paginator.num_pages }}</span>
  {% if products.has_next %}
    <a class="link" href="?q={{ q }}&category={{ active_category }}&sort={{ sort }}&page={{ products.next_page_number }}">Next</a>
  {% endif %}
</div>

<section>
  <p class="muted">Browse by category:
    {% for c in categories %}
      <a class="link" href="{% url 'shop:category' c.slug %}">{{ c.name }}</a>
    {% endfor %}
  </p>
</section>

{% if recently %}
<section>
  <h2 class="h2">Recently viewed</h2>
  <div class="grid">
    {% for p in recently %}
    <a class="card" href="{% url 'shop:product_detail' p.id %}">
      <div class="img" style="background-image:url('{{ p.image_url }}')"></div>
      <div class="card-body"><h3 class="card-title">{{ p.name }}</h3></div>
    </a>
    {% endfor %}
  </div>
</section>
{% endif %}
{% endblock %}
